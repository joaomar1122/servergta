import{u as h,r as s,q as o,_ as be,A as H,bb as M,P as A,az as X,p as c,bc as Ce,bd as Se,be as ye,C as z,a as n,F as se,j as v,bf as we,bg as Ae,bh as Oe,L as ne,s as K,bi as Re,bj as ie,bk as Ie,aU as Pe,bl as ke,a2 as Ne,t as oe,a6 as Le,b3 as Me,b as Ee,T as Ve}from"./index-a5f9a2c2.js";function Ke(){const d=h(Ee);h(z.CameraComponent);const F=h(M.Unlocked),ce=h(M.PassedFaceId),I=h(M.Visible);h(M.LockScreenVisible);const[T,O]=s.useState(!1),[i,$]=s.useState("Photo"),[E,G]=s.useState(!1),[le,W]=s.useState(!1),[q,V]=s.useState(null),[b,Q]=s.useState(!1),[f,ue]=s.useState(!1),[_,J]=s.useState(0),[de,x]=s.useState({}),m=h(Ve),g=h(H),B=s.useRef(null),U=s.useRef(null),C=s.useRef(null),u=s.useRef(null),P=s.useRef(!1),S=s.useRef(null),y=s.useRef(!1),p=["Video","Photo","Landscape"];s.useEffect(()=>{var e;y.current=!(m!=null&&m.visible)&&((e=g==null?void 0:g.active)==null?void 0:e.name)==="Camera"&&I},[C.current,m==null?void 0:m.visible,g==null?void 0:g.active,I]);const Y=()=>{i==="Photo"&&b&&!d.CustomCamera?u.current.setXOffset(-.2):b&&d.CustomCamera?u.current.setXOffset(.1):u.current.setXOffset(0)},fe=()=>{var e;o("info","Camera app is not active or open, pausing game render & releasing audio stream"),P.current=!1,(e=u.current)==null||e.pause(),S.current&&(ie("Camera"),S.current=null),i==="Landscape"&&c("Camera",{action:"toggleLandscape",toggled:!1},"OK"),c("Camera",{action:"close"},"OK")},me=async()=>{var r;P.current=!0,o("info","Camera app is active & open, initializing game render & audio stream"),u.current?u.current.paused&&u.current.resume():u.current=new Ie(C.current),c("Camera",{action:"open"},"OK"),c("Camera",{action:"flipCamera",value:b},"OK"),i==="Landscape"&&!((r=X)!=null&&r.value)?(c("Camera",{action:"toggleLandscape",toggled:!0},"OK"),A.Styles.Rotation.set(90)):i==="Video"&&c("Camera",{action:"toggleVideo",toggled:!0},"OK");const e=K.APPS.CAMERA.lastImage.value||await c("Camera",{action:"getLastImage"},Pe.Photos[0].src);if(e&&Z(e),P.current=!1,!S.current){const t=await ke("Camera");if(!y.current){o("info","camera app is no longer open, releasing audio stream"),ie("Camera");return}t&&(S.current=t)}};s.useEffect(()=>{if(o("info","Camera app active:",y.current),!C.current)return o("warning","Canvas ref is null");y.current&&P.current&&o("info","Camera app is already initializing, returning"),y.current?P.current||me():fe()},[y.current,C.current]),be("camera:usedCommand",e=>{var r;if(m!=null&&m.visible||((r=g==null?void 0:g.active)==null?void 0:r.name)!=="Camera"||!I)return o("info","camera:usedCommand - camera is not active, returning");switch(e){case"toggleTaking":k();break;case"toggleFlip":Q(t=>!t);break;case"toggleFlash":G(t=>!t);break;case"leftMode":if(f)return;$(t=>{const a=p.indexOf(t);return a===0?p[p.length-1]:p[a-1]});break;case"rightMode":if(f)return;$(t=>{const a=p.indexOf(t);return a===p.length-1?p[0]:p[a+1]});break}}),s.useEffect(()=>{if(!U.current)return;let e=[];const t=setInterval(()=>{e.length>2&&(e=[]),e.push("."),U.current.innerText=ne("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(t)},[T]);const Z=(e,r)=>{if(r===void 0&&(r=Ne(e)),r){const t=document.createElement("video");t.src=e,t.muted=!0,t.play().catch(()=>{});const a=document.createElement("canvas");if(!a)return;t.addEventListener("loadeddata",()=>{a.width=t.videoWidth,a.height=t.videoHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height);const R=a.toDataURL("image/png");B.current.style.backgroundImage=`url(${R})`,K.APPS.CAMERA.lastImage.set(R),a.remove(),t.remove()})}else B.current.style.backgroundImage=`url(${e})`,K.APPS.CAMERA.lastImage.set(e)};s.useEffect(()=>{if(!I)return()=>{H.patch({active:null}),F||M.LockScreenVisible.set(!0)}},[I]),s.useEffect(()=>{var r,t;if(f||!u.current)return;switch(i){case"Landscape":if((r=X)!=null&&r.value)return;x({marginRight:"9rem"}),A.Styles.Rotation.set(90);break;case"Video":A.Styles.Rotation.set(0),x({marginLeft:"12rem"});break;default:A.Styles.Rotation.set(0),x({marginLeft:"3rem"});break}if(i==="Landscape"){if((t=X)!=null&&t.value)return;u.current.resizeByAspect(16/9)}else(i==="Video"||i==="Photo")&&u.current.resizeByAspect(3/4);c("Camera",{action:"toggleLandscape",toggled:i==="Landscape"},"OK"),c("Camera",{action:"toggleVideo",toggled:i==="Video"},"OK");const e=window.innerWidth;e>1920&&u.current.setQuality(1920/e),Y()},[i]),s.useEffect(()=>{if(c("Camera",{action:"flipCamera",value:b},"OK"),!f){if(!y.current)return o("info","Camera app is not active, returning");Y()}},[F,b]);const ee=s.useRef(!0),te=async(e,r)=>{const t=oe(e.size/1e3,2);E&&c("toggleFlashlight",{toggled:!1},"OK");try{const a=await Le(r?"Video":"Image",e);if(!a)throw new Error("Failed to upload media (URL is null)");return Z(a),o("info",`Saving ${r?"video":"photo"} to gallery (${t}kb) - ${a}, args(${a}, ${t}, ${b&&!r?"selfie":null})`),await Me(a,t,b&&!r?"selfie":null,!0),!0}catch(a){throw a}};s.useEffect(()=>{if(ee.current){ee.current=!1;return}if(E&&!f&&c("toggleFlashlight",{toggled:!1},"OK"),!f)return;const e=C.current.captureStream(d.videoOptions.fps),r=new AudioContext,t=new MediaStreamAudioDestinationNode(r);S.current?r.createMediaStreamSource(S.current).connect(t):r.createOscillator().connect(t),Ce("Camera",r,t);const a=[e.getVideoTracks()[0]];(S.current||d.recordNearbyVoices)&&a.unshift(t.stream.getAudioTracks()[0]);const R=new MediaStream(a),w=new MediaRecorder(R,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:d.videoOptions.bitrate*8*1e3});let D=0;const pe=w.audioBitsPerSecond+w.videoBitsPerSecond,ae=setInterval(()=>{const l=(Date.now()-D)/1e3,j=pe*l/8/1024/1024,L=oe(j,2);L>=d.videoOptions.size&&(o("info",`Video file size limit reached (${L}mb)`),clearInterval(ae),k())},100);let re=[];w.ondataavailable=l=>{var N;((N=l==null?void 0:l.data)==null?void 0:N.size)>0&&re.push(l.data)},w.onerror=l=>{o("error","error recording:",l)},w.onstop=async()=>{clearInterval(ae);let l=Date.now()-D,N=new Blob(re,{type:"video/webm"});r.close(),O(!0),Se("Camera");const j=await ye(N,l,{logger:!1});try{await te(j,!0),o("info","Video uploaded successfully"),O(!1)}catch(L){o("error","Could not upload video",L),O(!1),V(L.message),await new Promise(ve=>setTimeout(ve,1e4)),V(null)}},D=Date.now(),w.start();const he=setInterval(()=>{if(_>=d.videoOptions.duration)return k();J(l=>l+1>=d.videoOptions.duration?(k(),0):l+1)},1e3);return()=>{J(0),clearInterval(he),w.stop()}},[f]);const ge=e=>{let r=(e%60).toString().padStart(2,"0"),t=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+t+":"+r},k=async()=>{var r,t;if(T)return o("info","Returning since an image is currently uploading");if(E&&await c("toggleFlashlight",{toggled:!0},"OK"),i=="Video"){await c("Camera",{action:"toggleHud",toggled:f},"OK"),ue(a=>!a);return}await c("Camera",{action:"toggleHud",toggled:!1},"OK"),(t=(r=A.Settings.value)==null?void 0:r.sound)!=null&&t.silent||A.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),W(!0),z.IndicatorVisible.set(!1),O(!0),o("info","Uploading image, converting to blob");const e=await new Promise(a=>C.current.toBlob(a,d.imageOptions.mime,d.imageOptions.quality));try{await te(e,!1),o("info","Image uploaded successfully"),O(!1),z.IndicatorVisible.set(!0)}catch(a){o("error","Could not upload image",a),O(!1),V(a.message),z.IndicatorVisible.set(!0),await new Promise(R=>setTimeout(R,1e4)),V(null)}W(!1),c("Camera",{action:"toggleHud",toggled:!0},"OK")};return n(se,{children:v("div",{className:"camera-container",children:[v("div",{className:"camera-header",children:[n("div",{className:"flash",onClick:()=>G(e=>!e),children:!f&&E?n(we,{}):n(Ae,{})}),i==="Video"&&v(se,{children:[n("div",{className:"timer",children:ge(_)}),n("span",{})]})]}),v("div",{className:`camera-body ${i=="Landscape"?"rotate":""}`,children:[n("canvas",{ref:C,style:{visibility:le?"hidden":"visible"}}),T&&v("div",{className:"loading",children:[n(Oe,{size:80,speed:1,color:"#ffffff"}),n("div",{className:"uploading",ref:U,children:"Uploading..."})]}),q&&n("div",{className:"loading",children:v("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua",n("br",{}),n("br",{}),q]})})]}),v("div",{className:"camera-bottom",children:[n("div",{className:"camera-types",style:de,children:p.map((e,r)=>n("div",{className:`${i===e&&"active"}`,onClick:()=>$(e),children:ne(`APPS.CAMERA.${e.toUpperCase()}`)},r))}),v("div",{className:"camera-buttons",children:[n("div",{className:"image-gallery",ref:B,onClick:()=>{!ce&&!F||(c("Camera",{action:"close"},"OK"),A.Styles.Rotation.set(0),H.patch({active:{name:"Photos",data:{photo:K.APPS.CAMERA.lastImage.value}}}))}}),n("div",{className:"camera-button",onClick:()=>k(),children:n("div",{className:"camera-button-container",children:n("div",{className:`camera-button-inner ${i=="Video"&&`${i} ${f==!0&&"Recording"}`}`})})}),n("div",{className:"flip-camera",onClick:()=>Q(e=>!e),children:n(Re,{})})]})]})]})})}export{Ke as default};
