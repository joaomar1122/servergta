var E=Object.defineProperty;var P=(a,t,e)=>t in a?E(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var s=(a,t,e)=>(P(a,typeof t!="symbol"?t+"":t,e),e),M=(a,t,e)=>{if(!t.has(a))throw TypeError("Cannot "+e)};var b=(a,t,e)=>(M(a,t,"read from private field"),e?e.call(a):t.get(a)),D=(a,t,e)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,e)},v=(a,t,e,r)=>(M(a,t,"write to private field"),r?r.call(a,e):t.set(a,e),e);import{bl as W,q as A,bc as j,be as F,bj as I,bd as L}from"./index-a5f9a2c2.js";const B=async(a,t=25,e=7,r=360,o=120,l)=>{let d=new AudioContext,i=document.createElement("canvas");i.width=r,i.height=o;const n=await d.decodeAudioData(await a.arrayBuffer());let u=(i.width-(t-1)*e)/t,C=i.height/2,p=l?Math.max(0,n.length-d.sampleRate*l):0,y=Math.floor((n.length-p)/t),S=n.getChannelData(0),f=i.getContext("2d");f.fillStyle="#000";for(let c=0;c<t;c++){let w=1,g=.001;for(let x=0;x<y;x++){let m=S[p+c*y+x]*15;m<w&&(w=m),m>g&&(g=m)}let R=Math.min(Math.max(6,(g-w)*C),i.height),T=C-R/2;f.beginPath(),f.roundRect(c*(u+e),T,u,R,5),f.fill()}const k=await new Promise(c=>i.toBlob(c)),N=i.toDataURL();return i.remove(),{blob:k,base64:N}},U=async(a,t=.01)=>{const e=new AudioContext,r=await a.arrayBuffer(),d=(await e.decodeAudioData(r)).getChannelData(0).every(i=>Math.abs(i)<t);return e.close(),d};var h;class V{constructor(){D(this,h,void 0);s(this,"audioCtx");s(this,"recorder");s(this,"destination");s(this,"chunks");s(this,"stream");s(this,"start",async(t,e)=>{if(!this.stream){const o=await W("AudioRecorder");if(!o)return A("error","AudioRecorder: Failed to get audio stream");this.stream=o}this.recorder&&(this.recorder.state!=="inactive"&&this.recorder.stop(),this.recorder=null,this.chunks=[]),this.audioCtx&&this.audioCtx.close(),this.audioCtx=new AudioContext,this.destination=new MediaStreamAudioDestinationNode(this.audioCtx),this.audioCtx.createMediaStreamSource(this.stream).connect(this.destination),j("AudioRecorder",this.audioCtx,this.destination),this.recorder=new MediaRecorder(this.destination.stream),this.recorder.ondataavailable=o=>{this.chunks.push(o.data),e&&e(this.chunks)},v(this,h,Date.now()),this.chunks=[],this.recorder.start(t)});s(this,"stop",async()=>{const{recorder:t,chunks:e}=this;if(b(this,h),!t)return A("error","AudioRecorder: Failed to end recording: not recording"),!1;const r=await new Promise(u=>{t.onstop=()=>{u(Date.now()-b(this,h))},t.stop()}),o=await F(new Blob(e,{type:t.mimeType}),r,{logger:!1});if(this.stream&&I("AudioRecorder"),this.audioCtx&&this.audioCtx.close(),L("AudioRecorder"),this.stream=null,this.audioCtx=null,await U(o))return A("info","AudioRecorder: Audio is quiet, not sending message"),!1;const l=await B(o),d=await B(o,60,7,960,200),i=new Audio;i.src=URL.createObjectURL(o);let n={blob:o};return n.waveform={message:l.blob,placeholder:d.base64},i.duration!==1/0&&!isNaN(i.duration)?{...n,duration:Math.round(i.duration)}:(i.currentTime=Number.MAX_SAFE_INTEGER,await new Promise(u=>{i.ontimeupdate=()=>u({...n,duration:Math.round(i.duration)})}))});this.recorder=null,this.chunks=[]}}h=new WeakMap;export{V as A,B as g};
